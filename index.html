<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMV QR Code Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        label {
            display: inline-block;
            width: 150px;
            margin-top: 4px;
        }
        input {
            width: calc(40% - 170px);
        }
    </style>
</head>
<body>
    <h1>DỮ LIỆU ĐẦU VÀO</h1>
    <form id="emvForm">
        <label for="version">00:</label>
        <input type="text" id="version" name="version" value="01"> (Phiên bản dữ liệu)<br>

        <label for="initmethod">01:</label>
        <input type="text" id="initmethod" name="initmethod" value="BVUB123456"> (Phương thức khởi tạo)<br>

        <label for="initmethod">38:</label><br>

        <label for="guid" style="margin-left: 30px;  width: 120px;">00:</label>
        <input type="text" id="guid" name="guid" value="A000000727"> (Guid)<br>

        <label for="initmethod" style="margin-left: 30px;">01:</label><br>

        <label for="acquierid" style="margin-left: 60px;  width: 90px;">00:</label>
        <input type="text" id="acquierid" name="acquierid" value="970436"> (Bank ID)<br>

        <label for="merchanid" style="margin-left: 60px;  width: 90px;">01:</label>
        <input type="text" id="merchanid" name="merchanid" value="0111000355111"> (Số tài khoản)<br>

        <label for="servicecode" style="margin-left: 30px;  width: 120px;">02:</label>
        <input type="text" id="servicecode" name="servicecode" value="QRIBFTTA"> (Method)<br>

        <label for="currency">53:</label>
        <input type="text" id="currency" name="currency" value="704"> (Mã tiền tệ)<br>

        <label for="amount">54:</label>
        <input type="text" id="amount" name="amount" value="1000"> (Số tiền thanh toán)<br>

        <label for="nationality">58:</label>
        <input type="text" id="nationality" name="nationality" value="VN"> (Mã quốc gia)<br>

        <label for="additionalInfo">62:</label>
        <input type="text" id="additionalInfo" name="additionalInfo" value="0824CHUYEN TIEN NHANH QUA QR"> (Thông tin bổ sung)<br><br>

        <button type="button" onclick="generateEMV()">Tạo QRData</button>
    </form>

    <h2>Chuỗi QRData:</h2>
    <p id="result"></p>
    <h2>QR Code:</h2>
    <canvas id="qrcode"></canvas>

    <script>
        class EMV {
            constructor(version, initmethod, guid, acquierid, merchanid, servicecode, currency, amount, nationality, additionalInfo) {
                this.version = version;
                this.initmethod = initmethod;
                this.guid = guid;
                this.acquierid = acquierid;
                this.merchanid = merchanid;
                this.servicecode = servicecode;
                this.currency = currency;
                this.amount = amount;
                this.nationality = nationality;
                this.additionalInfo = additionalInfo;
            }

            toEMVString() {
                let emvString = '';

                emvString += `00${this.version.length.toString().padStart(2, '0')}${this.version}`;
                emvString += `01${this.initmethod.length.toString().padStart(2, '0')}${this.initmethod}`;

                let beneficiaryString = '';
                beneficiaryString += `00${this.guid.length.toString().padStart(2, '0')}${this.guid}`;

                let acquier_id = `00${this.acquierid.length.toString().padStart(2, '0')}${this.acquierid}`;
                let merchan_id = `01${this.merchanid.length.toString().padStart(2, '0')}${this.merchanid}`;
                beneficiaryString += `01${(acquier_id + merchan_id).length.toString().padStart(2, '0')}${acquier_id + merchan_id}`;


                beneficiaryString += `02${this.servicecode.length.toString().padStart(2, '0')}${this.servicecode}`;

                emvString += `38${beneficiaryString.length.toString().padStart(2, '0')}${beneficiaryString}`;
                emvString += `53${this.currency.length.toString().padStart(2, '0')}${this.currency}`;
                emvString += `54${this.amount.length.toString().padStart(2, '0')}${this.amount}`;
                emvString += `58${this.nationality.length.toString().padStart(2, '0')}${this.nationality}`;
                emvString += `62${this.additionalInfo.length.toString().padStart(2, '0')}${this.additionalInfo}`;

                return emvString+6304;
            }

            calculateCRC(emvString) {
                // Tính CRC-16/CCITT-FALSE sử dụng thuật toán
                let crc = 0xFFFF;
                for (let i = 0; i < emvString.length; i++) {
                    crc ^= emvString.charCodeAt(i) << 8;
                    for (let j = 0; j < 8; j++) {
                        if (crc & 0x8000) {
                            crc = (crc << 1) ^ 0x1021;
                        } else {
                            crc <<= 1;
                        }
                        crc &= 0xFFFF; // Đảm bảo rằng giá trị CRC luôn nằm trong 16 bit
                    }
                }
                return crc.toString(16).toUpperCase().padStart(4, '0');
            }

            toEMVStringWithCRC() {
                const emvString = this.toEMVString();
                const crcValue = this.calculateCRC(emvString);
                return `${emvString}${crcValue}`;
            }
        }

        function generateEMV() {
            const version = document.getElementById('version').value;
            const initMethod = document.getElementById('initmethod').value;
            const identifier = document.getElementById('guid').value;
            const beneficiaryBankId = document.getElementById('acquierid').value;
            const beneficiaryAccountNumber = document.getElementById('merchanid').value;
            const method = document.getElementById('servicecode').value;
            const currency = document.getElementById('currency').value;
            const amount = document.getElementById('amount').value;
            const nation = document.getElementById('nationality').value;
            const additionalData = document.getElementById('additionalInfo').value;

            const emv = new EMV(version, initMethod, identifier, beneficiaryBankId, beneficiaryAccountNumber, method, currency, amount, nation, additionalData);
            const emvStringWithCRC = emv.toEMVStringWithCRC();

            document.getElementById('result').textContent = emvStringWithCRC;

            // Generate QR code
            const canvas = document.getElementById('qrcode');
            QRCode.toCanvas(canvas, emvStringWithCRC, function (error) {
                if (error) console.error(error);
                console.log('QR code generated!');
            });
        }
    </script>
</body>
</html>
